<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h2 fw-bold mb-2"><%= t('orders.show.title') %> <%= @order.order_no %></h1>
    <p class="text-muted mb-0">
      <i class="bi bi-calendar me-1"></i><%= @order.order_date %>
      <% if @order.company %>
        <span class="ms-3">
          <i class="bi bi-building me-1"></i><%= @order.company.name %>
        </span>
      <% end %>
    </p>
  </div>
  <div class="d-flex gap-2">
    <% if @order.can_be_edited? && current_user&.internal_admin? %>
      <%= link_to edit_order_path(@order), class: "btn btn-outline-secondary btn-sm" do %>
        <i class="bi bi-pencil me-1"></i><%= t('orders.show.edit') %>
      <% end %>
    <% end %>
    <%= link_to orders_path, class: "btn btn-outline-primary btn-sm" do %>
      <i class="bi bi-arrow-left me-1"></i><%= t('orders.show.back') %>
    <% end %>
  </div>
</div>

<% if @order.order_approval_request&.status_rejected? %>
  <div class="alert alert-danger border-0 shadow-sm d-flex align-items-start mb-4" role="alert">
    <i class="bi bi-x-circle-fill fs-4 me-3 mt-1"></i>
    <div class="flex-grow-1">
      <h6 class="alert-heading fw-semibold mb-2"><%= t('orders.show.rejected_heading') %></h6>
      <p class="mb-1 small">
        <%= t('orders.show.rejected_by') %>: <%= @order.order_approval_request.reviewed_by&.name || @order.order_approval_request.reviewed_by&.email %>
        （<%= @order.order_approval_request.reviewed_at&.strftime("%Y年%m月%d日 %H:%M") %>）
      </p>
      <% if @order.order_approval_request.review_comment.present? %>
        <p class="mb-0 small"><strong><%= t('orders.show.rejected_reason') %>:</strong> <%= @order.order_approval_request.review_comment %></p>
      <% end %>
    </div>
  </div>
<% end %>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white border-bottom">
        <h5 class="card-title mb-1 fw-bold">
          <i class="bi bi-info-circle me-2"></i><%= t('orders.show.order_details') %>
        </h5>
        <small class="text-muted"><%= t('orders.show.order_details_desc') %></small>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.status') %></label>
            <p class="mb-0">
              <%= render "orders/status_badge", status: @order.shipping_status, order: @order %>
            </p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.order_date') %></label>
            <p class="mb-0 fw-medium"><%= @order.order_date %></p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.ordered_by') %></label>
            <p class="mb-0">
              <i class="bi bi-person me-1"></i><%= @order.ordered_by_user.email %>
            </p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.total_amount') %></label>
            <p class="mb-0 fw-bold text-primary fs-5">
              <%= number_to_currency(@order.total_amount, unit: "¥", precision: 0) %>
            </p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.co2_total') %></label>
            <p class="mb-0">
              <% if @order.co2_total.present? %>
                <i class="bi bi-cloud me-1"></i><%= @order.co2_total %> kg
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white border-bottom">
        <h5 class="card-title mb-1 fw-bold">
          <i class="bi bi-truck me-2"></i><%= t('orders.show.shipping_info') %>
        </h5>
        <small class="text-muted"><%= t('orders.show.shipping_info_desc') %></small>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-12">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.customer') %></label>
            <p class="mb-0">
              <% if current_user&.internal_admin? || current_user&.company_admin? %>
                <%= link_to(customer_path(@order.customer), class: "text-decoration-none fw-medium") do %>
                  <i class="bi bi-building me-1"></i><%= @order.customer.display_name %>
                <% end %>
              <% else %>
                <i class="bi bi-building me-1"></i><%= @order.customer.display_name %>
              <% end %>
            </p>
          </div>
          <div class="col-md-12">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.ship_to') %></label>
            <p class="mb-0"><%= @order.full_shipping_address %></p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.tracking_no') %></label>
            <p class="mb-0 font-monospace">
              <% if @order.tracking_no.present? %>
                <% url = tracking_url_for(@order.shipping_carrier, @order.tracking_no) %>
                <%= url.present? ? link_to(@order.tracking_no, url, target: "_blank", rel: "noopener") : @order.tracking_no %>
              <% else %>
                -
              <% end %>
            </p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.ship_date') %></label>
            <p class="mb-0"><%= @order.ship_date || "-" %></p>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold text-muted small mb-1"><%= t('orders.show.delivered_date') %></label>
            <p class="mb-0"><%= @order.delivered_date || "-" %></p>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-bottom">
        <h5 class="card-title mb-1 fw-bold">
          <i class="bi bi-list-ul me-2"></i><%= t('orders.show.order_lines') %>
        </h5>
        <small class="text-muted"><%= t('orders.show.order_lines_desc') %></small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th><%= t('orders.show.item_code') %></th>
                <th><%= t('orders.show.item_name') %></th>
                <th class="text-end"><%= t('orders.show.quantity') %></th>
                <th class="text-end"><%= t('orders.show.unit_price') %></th>
                <th class="text-end"><%= t('orders.show.amount') %></th>
              </tr>
            </thead>
            <tbody>
              <% @order_lines.each do |line| %>
                <tr class="<%= 'table-warning' if line.item.nil? || !line.item.is_active %>">
                  <td class="font-monospace">
                    <% if line.item.nil? %>
                      <span class="text-muted"><%= t('orders.show.item_deleted') %></span>
                    <% else %>
                      <%= line.item_code %>
                    <% end %>
                  </td>
                  <td>
                    <% if line.item.nil? %>
                      <span class="text-muted"><%= t('orders.show.item_deleted') %></span>
                    <% elsif !line.item.is_active %>
                      <%= line.item_name %> <span class="badge bg-secondary small"><%= t('orders.show.item_inactive') %></span>
                    <% else %>
                      <%= line.item_name %>
                    <% end %>
                  </td>
                  <td class="text-end"><%= line.quantity %></td>
                  <td class="text-end text-muted">
                    <%= number_to_currency(line.unit_price_snapshot, unit: "¥", precision: 0) %>
                  </td>
                  <td class="text-end fw-semibold">
                    <%= number_to_currency(line.amount, unit: "¥", precision: 0) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="4" class="text-end fw-bold"><%= t('orders.show.total') %>:</td>
                <td class="text-end fw-bold fs-5 text-primary">
                  <%= number_to_currency(@order.total_amount, unit: "¥", precision: 0) %>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <% if current_user&.internal_admin? %>
    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-1 fw-bold">
            <i class="bi bi-gear me-2"></i><%= t('orders.show.actions') %>
          </h5>
          <small class="text-muted"><%= t('orders.show.actions_desc') %></small>
        </div>
        <div class="card-body">
          <div class="d-flex flex-column gap-2">
            <% if @order.shipping_status_confirmed? %>
              <%= form_with url: ship_order_path(@order), method: :post, local: true do |f| %>
                <div class="mb-3">
                  <%= f.label :tracking_no, t('orders.show.tracking_no'), class: "form-label fw-semibold small" %>
                  <%= f.text_field :tracking_no, class: "form-control form-control-sm", placeholder: t('orders.show.tracking_no_placeholder') %>
                </div>
                <%= f.submit t('orders.show.ship'), class: "btn btn-warning btn-sm w-100" %>
              <% end %>
            <% end %>

            <% if @order.shipping_status_shipped? %>
              <%= button_to deliver_order_path(@order), method: :post, class: "btn btn-success btn-sm w-100" do %>
                <i class="bi bi-check-circle me-1"></i><%= t('orders.show.deliver') %>
              <% end %>
            <% end %>

            <% if @order.can_be_cancelled? %>
              <%= button_to cancel_order_path(@order), method: :post, 
                  data: { confirm: t('orders.show.cancel_confirm') }, 
                  class: "btn btn-danger btn-sm w-100" do %>
                <i class="bi bi-x-circle me-1"></i><%= t('orders.show.cancel') %>
              <% end %>
            <% end %>

            <% unless @order.shipping_status_confirmed? || @order.shipping_status_shipped? || @order.can_be_cancelled? %>
              <p class="text-muted small mb-0 text-center">
                <i class="bi bi-info-circle me-1"></i><%= t('orders.show.no_actions') %>
              </p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
