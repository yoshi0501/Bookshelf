<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <div>
    <h1 class="h2 fw-bold mb-2"><%= t('dashboard.manufacturer_dashboard.title') %></h1>
    <p class="text-muted mb-0">
      <%= t('dashboard.welcome', name: current_user.name || current_user.email) %>
      <span class="badge bg-primary ms-2"><%= @manufacturer&.name %></span>
    </p>
    <p class="text-muted small mb-0 mt-1"><%= t('dashboard.manufacturer_dashboard.subtitle') %></p>
  </div>
  <div class="d-flex align-items-center gap-2">
    <%= link_to shipping_request_path(@manufacturer, month: Date.current.strftime("%Y-%m")), class: "btn btn-primary btn-sm" do %>
      <i class="bi bi-truck me-1"></i><%= t('dashboard.manufacturer_dashboard.go_to_shipping_requests') %>
    <% end %>
    <div class="d-none d-sm-flex align-items-center px-3 py-2 rounded bg-light border border-opacity-25">
      <i class="bi bi-calendar3 text-muted me-2"></i>
      <div>
        <span class="small text-muted d-block lh-1"><%= t('dashboard.today') %></span>
        <span class="fw-semibold text-dark" style="font-size: 0.95rem;"><%= format_date_with_weekday(Date.current) %></span>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-6 col-lg-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="d-inline-flex align-items-center justify-content-center rounded bg-success bg-gradient shadow-sm" style="width: 48px; height: 48px;">
              <i class="bi bi-currency-yen text-white fs-5"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <small class="text-muted d-block"><%= t('dashboard.manufacturer_dashboard.sales_this_month') %>（<%= Date.current.strftime("%Y年%m月") %>）</small>
            <h3 class="fw-bold mb-0"><%= number_to_currency(@manufacturer_sales_this_month, unit: "¥", precision: 0) %></h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="d-inline-flex align-items-center justify-content-center rounded bg-secondary bg-opacity-25 bg-gradient shadow-sm" style="width: 48px; height: 48px;">
              <i class="bi bi-currency-yen text-secondary fs-5"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <small class="text-muted d-block"><%= t('dashboard.manufacturer_dashboard.sales_last_month') %>（<%= 1.month.ago.strftime("%Y年%m月") %>）</small>
            <h3 class="fw-bold mb-0"><%= number_to_currency(@manufacturer_sales_last_month, unit: "¥", precision: 0) %></h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white border-bottom">
    <h5 class="card-title mb-1 fw-bold"><%= t('dashboard.manufacturer_dashboard.chart_title') %></h5>
    <small class="text-muted"><%= t('dashboard.manufacturer_dashboard.chart_subtitle') %></small>
  </div>
  <div class="card-body">
    <div class="position-relative" style="height: 280px;">
      <canvas id="manufacturerSalesChart" aria-label="<%= t('dashboard.manufacturer_dashboard.chart_title') %>"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
(function() {
  var data = <%= raw @manufacturer_chart_data.to_json %>;
  var labels = data.map(function(d) { return d.label; });
  var totalAmount = data.map(function(d) { return d.total_amount; });
  var ctx = document.getElementById('manufacturerSalesChart');
  if (!ctx) return;
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '<%= t("dashboard.manufacturer_dashboard.chart_series") %>',
        data: totalAmount,
        borderColor: 'rgb(25, 135, 84)',
        backgroundColor: 'rgba(25, 135, 84, 0.15)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: function(item) { return '¥' + Number(item.raw).toLocaleString(); }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: function(v) { return v >= 10000 ? (v/10000) + '万' : v; } }
        }
      }
    }
  });
})();
</script>
