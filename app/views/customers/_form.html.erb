<%= form_with model: customer do |f| %>
  <%= render "shared/form_errors", resource: customer %>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom">
      <h5 class="card-title mb-1 fw-bold">
        <i class="bi bi-building me-2"></i><%= t('customers.form.basic_info') %>
      </h5>
      <small class="text-muted"><%= t('customers.form.basic_info_desc') %></small>
    </div>
    <div class="card-body">
      <% if current_user&.internal_admin? %>
        <div class="row g-3 mb-3">
          <div class="col-md-12">
            <%= f.label :company_id, t('customers.form.company'), class: "form-label fw-semibold" %>
            <%= f.collection_select :company_id, @companies, :id, :name, 
                { prompt: t('customers.form.select_company') }, 
                { class: "form-select", id: "customer_company_id", onchange: "updateBillingCenters(this.value)" } %>
          </div>
        </div>
      <% end %>
      <div class="row g-3">
        <div class="col-md-12">
          <div class="form-check form-switch mb-3">
            <%= f.check_box :is_billing_center, class: "form-check-input", role: "switch", id: "customer_is_billing_center", onchange: "toggleBillingCenterFields()" %>
            <%= f.label :is_billing_center, t('customers.form.is_billing_center'), class: "form-check-label fw-semibold" %>
            <div class="form-text"><%= t('customers.form.is_billing_center_help') %></div>
          </div>
        </div>
        <div class="col-md-6" id="billing_center_field" style="<%= 'display: none;' if customer.is_billing_center? %>">
          <%= f.label :billing_center_id, t('customers.form.billing_center'), class: "form-label fw-semibold" do %>
            <%= t('customers.form.billing_center') %>
            <span class="text-danger">*</span>
          <% end %>
          <%= f.collection_select :billing_center_id, @billing_centers || [], :last, :first, 
              { include_blank: t('customers.form.select_billing_center') }, 
              { class: "form-select", id: "customer_billing_center_id", required: !customer.is_billing_center? } %>
          <div class="form-text"><%= t('customers.form.billing_center_help') %></div>
        </div>
        <div class="col-md-6" id="approver_field" style="<%= 'display: none;' unless customer.is_billing_center? %>">
          <%= f.label :approver_user_profile_id, t('customers.form.approver'), class: "form-label fw-semibold" %>
          <%= f.collection_select :approver_user_profile_id, @approver_candidates || [], :last, :first,
              { include_blank: t('customers.form.select_approver') },
              { class: "form-select", id: "customer_approver_user_profile_id" } %>
          <div class="form-text"><%= t('customers.form.approver_help') %></div>
        </div>
        <div class="col-md-6">
          <%= f.label :center_code, t('customers.form.center_code'), class: "form-label fw-semibold" %>
          <%= f.text_field :center_code, class: "form-control font-monospace" %>
        </div>
        <div class="col-md-12">
          <%= f.label :center_name, t('customers.form.center_name'), class: "form-label fw-semibold" %>
          <%= f.text_field :center_name, class: "form-control" %>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom">
      <h5 class="card-title mb-1 fw-bold">
        <i class="bi bi-geo-alt me-2"></i><%= t('customers.form.address_info') %>
      </h5>
      <small class="text-muted"><%= t('customers.form.address_info_desc') %></small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <%= f.label :postal_code, t('customers.form.postal_code'), class: "form-label fw-semibold" %>
          <%= f.text_field :postal_code, placeholder: "123-4567", class: "form-control" %>
        </div>

        <div class="col-md-4">
          <%= f.label :prefecture, t('customers.form.prefecture'), class: "form-label fw-semibold" %>
          <%= f.text_field :prefecture, class: "form-control" %>
        </div>

        <div class="col-md-4">
          <%= f.label :city, t('customers.form.city'), class: "form-label fw-semibold" %>
          <%= f.text_field :city, class: "form-control" %>
        </div>

        <div class="col-12">
          <%= f.label :address1, t('customers.form.address1'), class: "form-label fw-semibold" %>
          <%= f.text_field :address1, class: "form-control" %>
        </div>

        <div class="col-12">
          <%= f.label :address2, t('customers.form.address2'), class: "form-label fw-semibold" %>
          <%= f.text_field :address2, class: "form-control" %>
          <small class="form-text text-muted"><%= t('customers.form.address2_optional') %></small>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom">
      <h5 class="card-title mb-1 fw-bold">
        <i class="bi bi-toggle-on me-2"></i><%= t('customers.form.status') %>
      </h5>
      <small class="text-muted"><%= t('customers.form.status_desc') %></small>
    </div>
    <div class="card-body">
      <div class="form-check form-switch">
        <%= f.check_box :is_active, class: "form-check-input", role: "switch" %>
        <%= f.label :is_active, t('customers.form.is_active'), class: "form-check-label fw-semibold" %>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-end gap-2">
    <%= link_to t('shared.actions.cancel'), customers_path, class: "btn btn-outline-secondary" %>
    <%= f.submit t('shared.actions.save'), class: "btn btn-primary" %>
  </div>
<% end %>

<script>
  function updateBillingCenters(companyId) {
    if (!companyId) {
      const select = document.getElementById('customer_billing_center_id');
      if (select) {
        select.innerHTML = '<option value=""><%= j(t('customers.form.select_billing_center')) %></option>';
      }
      return;
    }

    fetch(`/customers.json?company_id=${companyId}&billing_centers_only=true`)
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('customer_billing_center_id');
        if (select) {
          select.innerHTML = '<option value=""><%= j(t('customers.form.select_billing_center')) %></option>';
          data.forEach(billingCenter => {
            const option = document.createElement('option');
            option.value = billingCenter.id;
            option.textContent = billingCenter.display_name;
            select.appendChild(option);
          });
        }
      })
      .catch(error => {
        console.error('Error loading billing centers:', error);
      });
  }

  function toggleBillingCenterFields() {
    const isBillingCenter = document.getElementById('customer_is_billing_center').checked;
    const billingCenterField = document.getElementById('billing_center_field');
    const billingCenterSelect = document.getElementById('customer_billing_center_id');
    const approverField = document.getElementById('approver_field');
    if (approverField) {
      approverField.style.display = isBillingCenter ? 'block' : 'none';
    }
    if (isBillingCenter) {
      billingCenterField.style.display = 'none';
      if (billingCenterSelect) {
        billingCenterSelect.value = '';
        billingCenterSelect.removeAttribute('required');
      }
    } else {
      billingCenterField.style.display = 'block';
      if (billingCenterSelect) {
        billingCenterSelect.setAttribute('required', 'required');
      }
    }
  }

  // ページ読み込み時に実行
  document.addEventListener('DOMContentLoaded', function() {
    toggleBillingCenterFields();
  });
</script>

