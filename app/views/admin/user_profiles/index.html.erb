<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h2 fw-bold mb-2"><%= t('user_profiles.index.title') %></h1>
    <p class="text-muted mb-0"><%= t('user_profiles.index.description') %></p>
  </div>
</div>

<% if @companies.present? && (@companies.size > 1 || current_user&.internal_admin?) %>
  <ul class="nav nav-tabs mb-4" role="tablist">
    <% if current_user&.internal_admin? %>
      <li class="nav-item" role="presentation">
        <%= link_to admin_user_profiles_path(company_id: "unassigned"), class: "nav-link #{'active' if @show_unassigned}", data: { turbo: false } do %>
          <i class="bi bi-person-x me-1"></i>未割り当て
        <% end %>
      </li>
      <li class="nav-item" role="presentation">
        <%= link_to admin_user_profiles_path(company_id: "manufacturers"), class: "nav-link #{'active' if @show_manufacturers}", data: { turbo: false } do %>
          <i class="bi bi-truck me-1"></i>メーカーアカウント
        <% end %>
      </li>
    <% end %>
    <% @companies.each do |company| %>
      <li class="nav-item" role="presentation">
        <%= link_to admin_user_profiles_path(company_id: company.id),
            class: "nav-link #{'active' if @selected_company&.id == company.id && !@show_unassigned && !@show_manufacturers}",
            data: { turbo: false } do %>
          <i class="bi bi-building me-1"></i><%= company.name %>
        <% end %>
      </li>
    <% end %>
  </ul>
<% end %>

<div class="card shadow-sm border-0">
  <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
    <div>
      <h5 class="card-title mb-1 fw-bold">
        <% if @show_unassigned %>
          未割り当て - <%= t('user_profiles.index.title') %>
        <% elsif @show_manufacturers %>
          メーカーアカウント - <%= t('user_profiles.index.title') %>
        <% elsif @selected_company %>
          <%= @selected_company.name %> - <%= t('user_profiles.index.title') %>
        <% else %>
          <%= t('user_profiles.index.title') %>
        <% end %>
      </h5>
      <small class="text-muted"><%= @show_unassigned ? "メーカーアカウントに割り当て可能なユーザー" : @show_manufacturers ? "プラットフォーム共通のメーカーに紐づくアカウント" : t('user_profiles.index.description') %></small>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @user_profiles.empty? %>
      <div class="text-center py-5">
        <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-light mb-3" style="width: 64px; height: 64px;">
          <i class="bi bi-people text-muted fs-3"></i>
        </div>
        <p class="text-muted fw-medium mb-3">メンバーがありません</p>
        <p class="text-muted small">
          <% if @show_unassigned %>
            未割り当てのユーザーはいません。
          <% elsif @show_manufacturers %>
            メーカーアカウントはありません。
          <% elsif @selected_company %>
            <%= @selected_company.name %>にメンバーが登録されていません。
          <% else %>
            メンバーが登録されていません。
          <% end %>
        </p>
      </div>
    <% else %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th><%= t('user_profiles.table.name') %></th>
              <th><%= t('user_profiles.table.email') %></th>
              <th><%= t('user_profiles.table.role') %></th>
              <th>上司</th>
              <th><%= t('user_profiles.table.phone') %></th>
              <th class="text-end"><%= t('user_profiles.table.actions') %></th>
            </tr>
          </thead>
          <tbody>
            <% @user_profiles.each do |profile| %>
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                      <span class="text-primary fw-semibold small"><%= profile.name.first.upcase %></span>
                    </div>
                    <span class="fw-medium"><%= profile.name %></span>
                  </div>
                </td>
                <td class="text-muted"><%= profile.user.email %></td>
                <td>
                  <% if profile.manufacturer_user? %>
                    <span class="badge bg-info">メーカー</span>
                  <% else %>
                    <% case profile.role %>
                    <% when "internal_admin" %>
                      <span class="badge bg-danger">Internal Admin</span>
                    <% when "company_admin" %>
                      <span class="badge bg-primary">Company Admin</span>
                    <% when "normal" %>
                      <span class="badge bg-secondary">Normal</span>
                    <% end %>
                  <% end %>
                </td>
                <td class="text-muted"><%= profile.supervisor&.name || "-" %></td>
                <td class="text-muted"><%= profile.phone || "-" %></td>
                <td class="text-end">
                  <div class="d-flex gap-2 justify-content-end">
                    <%= link_to admin_user_profile_path(profile), class: "btn btn-sm btn-outline-primary" do %>
                      <i class="bi bi-eye me-1"></i><%= t('shared.actions.view') %>
                    <% end %>
                    <%= link_to edit_admin_user_profile_path(profile), class: "btn btn-sm btn-outline-secondary" do %>
                      <i class="bi bi-pencil me-1"></i><%= t('shared.actions.edit') %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
</div>

<%= render "shared/pagination", pagy: @pagy %>
