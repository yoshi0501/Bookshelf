# Bookshelf（プラRE）要件適合チェックリスト — 実装ギャップ一覧

コーディングせず、現行実装と要件を照合した「できていないところ」の一覧です。

---

## 0. 前提・スコープ

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 対象は「循環対象商品」だけ | 商品は一般の Item（循環に特化した区分なし） | **循環対象商品**のフラグやカテゴリがなく、全商品が同列 |
| 「回収ストレッチフィルム由来のゴミ袋」をモデル化 | 商品は item_code / name / unit_price 等の汎用項目のみ | **由来・素材・循環品かどうか**を表す項目やモデルがない |
| 顧客の拠点＝センター/DC/TC を複数持てる | ✅ Customer が請求先/受注拠点（billing_center / receiving）で複数拠点を表現 | ほぼ適合 |

---

## 1. マルチテナント（B2B構成）

| 要件 | 現状 | ギャップ |
|------|------|----------|
| テナント（企業）分離・データ混在しない | ✅ Company 単位で分離、Policy でスコープ | 適合 |
| 企業内に複数拠点（センター）を持てる | ✅ Customer が billing_center / receiving_centers で複数拠点 | 適合 |
| 取引先（売り手/買い手）の関係を持てる（将来の市場化） | 会社（Company）と顧客拠点（Customer）のみ。売り手/買い手の「取引先」マスタや関係テーブルなし | **取引先関係**（売り手・買い手の組み合わせ）のモデル・画面なし |
| 拠点ごとの権限（閲覧/承認/発注）が分けられる | 会社・ロール（管理者/一般）単位。ダッシュボードでセンター絞り込みは可能 | **拠点（センター）ごとの権限**（例：拠点Aのみ閲覧可）は未実装。同一会社内は全拠点が見える |

---

## 2. 取引ライフサイクル（循環トランザクション）

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 発注（Order） | ✅ Order / OrderLine で発注・明細を管理 | 適合 |
| 出荷/納品（Delivery） | Order の shipping_status（draft→confirmed→shipped→delivered）で表現。**Delivery という別エンティティはなし** | 納品日・出荷ロット等を「Delivery」として独立して持つ設計ではない |
| **回収（Collection：kg）** | 回収量（kg）を扱うテーブル・画面・集計なし | **回収（Collection）が未実装** |
| **再生（Reprocessing：kg）** | 再生量（kg）を扱うテーブル・画面・集計なし | **再生（Reprocessing）が未実装** |
| **再投入（Re-issue：ゴミ袋納品kg or 枚）** | 再投入量を扱うテーブル・画面・集計なし | **再投入（Re-issue）が未実装** |
| 「回収→再生→再投入」の紐づけ（同一ロット/期間/拠点で追跡） | 上記がないため紐づけモデルもなし | **紐づけルール・テーブルが未実装** |
| 拠点別・月次で循環率が出せる | 回収/再生/再投入がないため循環率の定義・計算なし | **循環率の算出・表示が未実装** |

---

## 3. 物販マージンモデル

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 商品マスタに原価・販売単価・マージンの概念 | ✅ Item に unit_price, cost_price。OrderLine に snapshot。マージンは計算で可 | 適合 |
| 取引量（kg/枚）で売上・粗利が自動集計 | 売上・粗利は **数量（個）× 単価/原価** で集計。**単位は「個」**。kg/枚の単位管理や kg 連動集計なし | **「kg連動で積み上がる」は未対応**。単位が個で、kg/枚の取引量での集計になっていない（最優先3点の1つ） |
| 拠点別・企業別に月次売上/粗利が見れる | ✅ ダッシュボードで会社・センター絞り込み、月別収益・原価・損益（管理者） | 適合 |
| 請求書・明細のPDFが取引データから生成できる | ✅ InvoiceGenerator / StatementGenerator で PDF 生成 | 適合 |

---

## 4. CO2算定（実削減＋残余＋オフセットを分離）

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 4-1 実削減（Avoided） | Item に co2_per_unit。OrderLine/Order に co2_amount / co2_total。**「実削減」としての区分なし**。単一の CO2 値として集計 | **実削減（Avoided）を残余・オフセットと分離していない**（最優先3点の1つ） |
| 計算前提（係数・境界条件）を保存 | co2_per_unit のみ。係数の根拠・境界・変更履歴用テーブルなし | **係数・境界条件の保存・履歴が未実装** |
| 4-2 残余排出 | 回収・再生・輸送等の残余排出を別枠で計上するモデル・項目なし | **残余排出の別枠計上が未実装** |
| ダッシュボードで実削減/残余が分離表示 | 月別 CO2 は 1 種類（co2_total の合計）のみ。実削減/残余の分離表示なし | **実削減と残余の分離表示が未実装** |
| 4-3 オフセット（任意） | オフセット ON/OFF・手法・価格差・オフセット量のテーブル・ロジックなし | **オフセット機能が未実装**（国産バイオ炭登録・価格差・ON/OFF 含む） |
| CN達成表示（残余100%オフセット時のみ） | CN 表示の概念・条件・UI なし | セクション5 と合わせて未実装 |

---

## 5. ゼロカーボン表示ルール（グリーンウォッシュ耐性）

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 会社全体ではなく取引単位でのみ CN 表示 | CN 表示の仕様・UI なし | **取引単位での CN 表示が未実装**（最優先3点の1つ） |
| CN 表示条件の明示（実削減算出済み・残余明示・残余100%オフセット・証跡ID等） | 該当するデータ項目・条件・表示なし | **CN 表示条件・証跡の仕様と実装が未実装** |
| オフセット OFF 時に「未オフセット（残余あり）」を UI 表示 | オフセット・残余の概念がないため該当 UI なし | 未実装 |

---

## 6. ダッシュボード（VC/顧客向けKPI）

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 月次：回収量（kg） | 回収データなし | **未実装** |
| 月次：再生量（kg） | 再生データなし | **未実装** |
| 月次：再投入量（kg/枚） | 再投入データなし | **未実装** |
| 月次：新品PE削減量（kg） | 該当する指標・集計なし | **未実装** |
| 月次：CO2（実削減 / 残余 / オフセット） | 月別 CO2 は 1 種類（co2_total）のみ。実削減/残余/オフセットの内訳なし | **実削減/残余/オフセットの分離表示が未実装** |
| 拠点別ランキング（回収率・循環率） | 回収・再生・再投入がないためランキング不可 | **未実装** |
| 売上・粗利（拠点別/会社別） | ✅ ダッシュボードで月別収益・原価・損益（管理者は原価・損益も） | 適合（ただし単位は「個」ベースで kg 連動ではない） |

---

## 7. PoC運用要件（10→100→600拠点）

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 拠点追加が簡単（マスタ作業が重くない） | ✅ Customer の CRUD、CSV インポート（customers/items） | 適合 |
| CSV インポート/エクスポート | ✅ 顧客・商品の CSV インポート。発注の CSV エクスポート | 適合 |
| 権限・承認フローが最低限回る | ✅ 発注承認（OrderApprovalRequest）、メンバー承認（ApprovalRequest） | 適合 |
| データが欠けても暫定運用できる（例：回収kg後入力） | 回収・再生・再投入が未実装のため、後入力の設計もなし | 回収等の後入力仕様は未検討 |

---

## 8. 監査・証跡

| 要件 | 現状 | ギャップ |
|------|------|----------|
| 取引イベント（誰が・いつ・何を）ログが残る | ✅ PaperTrail（versions, whodunnit）。Auditable で Order 等を追跡 | 適合 |
| 計算係数やロジック変更履歴が残る | Item の co2_per_unit 等は PaperTrail で変更は追える。**係数・ロジックの「説明用」メタデータや履歴テーブルはなし** | **係数・ロジックの説明用の保存・履歴が弱い** |
| PDF（請求書/明細）に参照IDが入る（追跡できる） | 請求書 PDF に **発注番号・請求書固有の参照ID・証跡IDは記載していない**。締日・会社コードはあり | **PDF への参照ID/証跡IDの記載が未実装** |

---

## 最優先で合っていてほしい3点 — ギャップ要約

1. **実削減/残余/オフセットを絶対に混ぜない**  
   → **未達**。現状は CO2 を 1 種類（co2_per_unit → co2_amount/co2_total）でしか持っておらず、実削減・残余・オフセットの区分も保存もしていない。

2. **CN 表示は取引単位のみ**  
   → **未達**。CN 表示のルール・条件・取引単位での表示が未実装。

3. **売上と粗利が“kg連動で”積み上がる**  
   → **未達**。売上・粗利は「数量（個）× 単価/原価」で積み上がっているが、**単位は個**。kg/枚の取引量で連動した集計にはなっていない。

---

## まとめ：未実装・不足が大きいブロック

- **2. 取引ライフサイクル**  
  回収（Collection）・再生（Reprocessing）・再投入（Re-issue）およびその紐づけ・循環率が**一通り未実装**。
- **4. CO2算定**  
  実削減/残余/オフセットの**分離モデル・分離表示が未実装**。係数・境界の説明用保存も弱い。
- **5. ゼロカーボン表示**  
  CN 表示の**条件・取引単位表示・証跡が未実装**。
- **6. ダッシュボード**  
  回収量・再生量・再投入量・新品PE削減・CO2内訳・拠点ランキング（回収率・循環率）が**未実装**。
- **3・最優先3点**  
  「kg 連動の売上・粗利」「実削減/残余/オフセットの混在禁止」「取引単位の CN 表示」は、いずれも**未実装または未達**。

上記を満たすには、循環用のモデル（回収・再生・再投入・紐づけ）、CO2 の 3 区分（実削減/残余/オフセット）、単位（kg/枚）の明示とそれに基づく集計、CN 表示ルールと証跡IDの設計・実装が必要です。
