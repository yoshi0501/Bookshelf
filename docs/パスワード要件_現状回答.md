# パスワード要件に関する現状の回答

本ドキュメントは、要件と現行アプリケーション（Bookshelf）の実装を対応付けた回答です。

---

## 1. ８桁以上且つ英数字混在の組み合わせとする

| 項目 | 現状 | 対応 |
|------|------|------|
| 桁数 | **8 文字以上** 128 文字以下（`config.password_length = 8..128`） | ✅ ８桁以上 |
| 英数字混在 | 未設定（コメントアウト） | ✅ **対応済み** — `config.password_complexity` で英数字混在を必須に設定 |

**回答**: パスワードは **8 文字以上**とし、**英字（大文字・小文字）と数字をそれぞれ 1 文字以上含む**英数字混在の組み合わせとする。

---

## 2. ユーザーＩＤと同一のパスワードは許可しない

| 項目 | 現状 | 対応 |
|------|------|------|
| 同一チェック | 未実装 | ✅ **対応済み** — ログインＩＤ（メールアドレス）と同一のパスワードを禁止するバリデーションを追加 |

**回答**: ユーザーＩＤ（本システムでは**メールアドレス**）と同一のパスワードは設定できないよう、バリデーションで拒否する。

---

## 3. 連続して一定回数以上パスワード入力に失敗した場合、アカウント使用不可又は一定時間ログイン不可とする

| 項目 | 現状 | 対応 |
|------|------|------|
| ロック | Devise Lockable を利用 | ✅ 対応済み |
| 失敗回数 | `maximum_attempts = 5` | 連続 **5 回**失敗でロック |
| 解除 | `unlock_in = 1.hour` およびリセットメール | **1 時間**後に自動解除、またはパスワードリセットメールで解除 |

**回答**: ログイン時に連続して **5 回**パスワード入力に失敗した場合、当該アカウントを **1 時間ログイン不可**とする。解除は 1 時間経過後の自動解除、または「パスワードを忘れた場合」からリセットする方法による。

---

## 4. パスワード入力時に他者から見えないようマスクした表示にする

| 項目 | 現状 | 対応 |
|------|------|------|
| 表示 | 全パスワード入力欄で `password_field`（`type="password"`）を使用 | ✅ 対応済み |
| トグル | パスワード表示/非表示切替ボタン（任意表示）を実装 | ✅ 対応済み |

**回答**: パスワード入力時は **マスク表示**（ブラウザのパスワード入力欄）とし、必要に応じてユーザーが表示/非表示を切り替えられるようにしている。

---

## 5. 有効期限を３か月以内とする

| 項目 | 現状 | 対応 |
|------|------|------|
| 有効期限 | `config.expire_password_after = 90.days`（devise-security） | ✅ 3 か月（90 日）で期限切れ |
| モジュール | User に `:password_expirable` を付与 | 期限切れ時はパスワード変更画面へリダイレクト |

**回答**: パスワードの有効期限は **3 か月（90 日）以内**とし、期限経過後はログイン時にパスワード変更画面へ誘導する。

---

## 6. ユーザーごとに異なるパスワードを設定する

| 項目 | 現状 | 対応 |
|------|------|------|
| 設計 | 各ユーザーが自身のパスワードを保持（Devise の通常の動作） | ✅ 対応済み |

**回答**: ユーザーごとに**異なるパスワード**を設定する設計であり、他ユーザーと共通化されることはない。

---

## 7. 「aaa」「1234」等の単純な文字列及び「password」等推測されやすい単語の使用は不可とする

| 項目 | 現状 | 対応 |
|------|------|------|
| 単純・推測されやすいパスワード | 未実装 | ✅ **対応済み** — 英数字混在に加え、よくある単語・連番のブラックリストチェックを追加 |

**回答**: **英数字混在**を必須とし、加えて「aaa」「1234」「password」等の**単純な文字列および推測されやすい単語**をブラックリストで拒否する。

---

## 8. ユーザー自身が、初回アクセス時にパスワードを設定する

| 項目 | 現状 | 対応 |
|------|------|------|
| 初回設定 | 新規登録（サインアップ）時にユーザー自身がパスワードを入力 | ✅ 対応済み |
| フロー | メールアドレス＋パスワード＋確認用パスワードを登録画面で入力 | 管理者による事前パスワード発行は行わず、本人が設定 |

**回答**: **初回アクセス時**（新規登録時）に、**ユーザー自身がパスワードを設定**する。管理者が初期パスワードを設定する方式はとっていない。

---

## 9. パスワードの有効期限接近時には、変更を促す

| 項目 | 現状 | 対応 |
|------|------|------|
| 期限切れ時 | devise-security の `:password_expirable` により、期限切れ後はパスワード変更へリダイレクト | ✅ 対応済み |
| 接近時 | 期限の「接近」時に変更を促す表示は未実装 | ✅ **対応済み** — 期限の約 2 週間前からフラッシュで変更を促す |

**回答**: パスワードの有効期限**経過後**はパスワード変更画面へ誘導する。あわせて、有効期限の**約 2 週間前**からログイン後画面で「パスワードの有効期限が近づいています」と表示し、**変更を促す**。

---

## まとめ（要件と実装の対応表）

| 要件 | 実装状況 |
|------|----------|
| ８桁以上且つ英数字混在 | ✅ 8 文字以上 + password_complexity（英数字混在） |
| ユーザーＩＤと同一不可 | ✅ カスタムバリデーション（メールアドレスと同一拒否） |
| 連続失敗でロック | ✅ Lockable（5 回で 1 時間ロック） |
| マスク表示 | ✅ password_field 使用 |
| 有効期限 3 か月以内 | ✅ 90 日（password_expirable） |
| ユーザーごとに異なるパスワード | ✅ 設計上保証 |
| 単純・推測されやすい単語の使用不可 | ✅ 英数字混在 + ブラックリスト |
| 初回アクセス時に本人がパスワード設定 | ✅ 新規登録時に本人が設定 |
| 有効期限接近時に変更を促す | ✅ 約 2 週間前からフラッシュで促し |
