# 商品原価と請求・履歴

## 発送元請求に使う原価

- 商品マスタ（Item）に **原価（cost_price）** を登録する。
- 発注時に **OrderLine** へ **cost_price_snapshot** としてコピーされる。単価と同様に「その時点の値」で固定される。
- そのため、**後から商品の原価を変更しても、過去の発注・請求の根拠は変わらない**。発送元への請求は発注時点の原価（スナップショット）で一貫して参照できる。

## 原価が変わったときの履歴保存

- **Item は `Auditable`（PaperTrail）を include している**ため、`cost_price` を変更するたびに **versions テーブル** に記録される。
- 保存される内容の例:
  - **いつ**: `versions.created_at`
  - **誰が**: `versions.whodunnit`（ユーザーID）
  - **何をどう変えたか**: `versions.object_changes`（JSON。例: `{"cost_price"=>[1000, 1100]}`）
- 監査や「当時なぜその原価だったか」の説明に、**原価変更の履歴**として参照できる。

## 参照方法の例

- ある商品の原価変更履歴を見る場合:
  - `PaperTrail::Version.where(item_type: "Item", item_id: item.id).order(created_at: :desc)`
  - 各 version の `object_changes` に `cost_price` の変更前後の値が入る。
- ある発注の原価根拠を見る場合:
  - その発注の `order_lines` の **cost_price_snapshot** を参照すれば、発注時点の原価が分かる。

## まとめ

| 目的                 | 使うデータ                          |
|----------------------|-------------------------------------|
| 発送元請求・過去の原価 | OrderLine の **cost_price_snapshot** |
| 原価変更の履歴・証跡   | **versions**（PaperTrail、Item の変更） |

原価が「あるタイミングで変わった場合」も、**履歴は versions に保存されている**。必要に応じて管理画面やAPIで「原価変更履歴」を参照する機能を足すことは可能。
