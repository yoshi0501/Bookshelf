# アクセスログの実装仕様

アクセスログの実装内容と、ロールごとのアクセス範囲を整理した設計案です。

---

## 1. アクセスログに記録する項目（中身）

| 項目 | 内容 |
|------|------|
| **ユーザー名** | ログインしているユーザーの氏名（UserProfile.name） |
| **ユーザーID** | メールアドレス（User.email）またはユーザーID。ログ検索用。 |
| **送信** | アクセス内容（リクエスト）。例：`GET /orders`、`POST /orders`、`PATCH /orders/123`、`GET /admin/user_profiles` 等。コントローラ#アクションまたはパス＋メソッド。 |
| **日時** | アクセス日時（タイムゾーン込み） |
| **IPアドレス** | クライアントIP（request.remote_ip） |
| **User-Agent** | ブラウザ・クライアント情報（任意） |
| **会社ID** | 該当ユーザーが属する会社（テナント）。ログ絞り込み・漏洩防止用。 |

---

## 2. 想定する実装方式

### 2.1 記録対象

- **発注関連**：発注一覧・新規・編集・詳細・承認・出荷・キャンセル等
- **承認関連**：発注承認・メンバー承認の表示・承認/却下
- **管理機能**：ログ参照、アカウント作成・削除・権限付与・取得（ユーザー管理）

※全リクエストを記録するか、上記に限定するかは運用方針次第です。

### 2.2 保持期間

- **3ヶ月分**を保持
- 古いログはバッチで削除（例：日次で 3ヶ月前より古いレコードを削除）

---

## 3. 管理者によるログ参照

- **管理者**（内部管理者・会社管理者等、権限を持つユーザー）がログ画面で参照
- 自社分のみ、またはシステム全体（内部管理者のみ）など、ロールに応じて表示範囲を制限

---

## 4. ロールごとのシステムアクセス範囲（ログ記録の前提）

アクセスログは、各ロールがどの操作を行ったかを記録する前提で、ロールごとのアクセス範囲を整理します。

| ロール | アクセス範囲 | ログに記録される想定 |
|--------|--------------|----------------------|
| **一般ユーザー** | 発注のみ（一覧・新規・編集・詳細・CSV エクスポート等） | 発注関連のアクセス |
| **承認ユーザー** | 発注 ＋ 承認（発注承認・メンバー承認の表示・承認/却下） | 発注 ＋ 承認関連のアクセス |
| **管理ユーザー** | 上記 ＋ ログ参照、アカウント管理（作成・削除・権限付与・取得） | ログ参照、ユーザー管理を含む全アクセス |

※「承認ユーザー」は上司（supervisor）や会社管理者等、承認権限を持つユーザーを想定。  
※「管理ユーザー」は内部管理者・会社管理者を想定。ログ参照権限は内部管理者のみなど、さらに細かく制御することも可能。

---

## 5. 現状の実装との関係

| 機能 | 現状 |
|------|------|
| **PaperTrail（versions）** | データ変更履歴（誰がいつ何を変更したか）を記録。レコード単位の create/update/destroy。アクセスログ（リクエスト単位の記録）とは別物。 |
| **IntegrationLog** | 外部連携（発注エクスポート等）のログ。ユーザーアクセスログとは別物。 |
| **専用アクセスログ** | 未実装。リクエスト単位で「誰がいつどのパスにアクセスしたか」を記録するテーブル・処理は現状なし。 |

本仕様に基づくアクセスログを実装する場合は、専用の `access_logs` テーブルと ApplicationController の `before_action` 等でリクエストを記録する実装が必要です。
