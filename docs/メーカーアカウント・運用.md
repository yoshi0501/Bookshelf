# メーカーアカウント（プラットフォーム共通）運用・トラブルシュート

## クイック手順（メーカーでログインできるようにする）

プロジェクトで以下を**この順**で実行する。

```bash
cd /Users/fukuyama/Desktop/ecoowl/Bookshelf
bin/rails db:migrate
bin/rails users:fix_maker
```

その後、ブラウザでログインする。

- **メール**: `maker-m01@platform.example.com`（m02, m03, m04 も可）
- **パスワード**: `SeedPass1`（S・P 大文字、末尾 1。コピペ推奨）

ログイン後は発送依頼画面にリダイレクトされ、メーカー用メニューのみ利用可能。

---

## 前提

- **メーカーはプラットフォーム共通マスタ**であり、会社に属さない。
- **1メーカーが複数会社に供給**する想定。メーカー用户でログインすると、自メーカーが紐づく発注を**全社分**参照できる（発送依頼画面のみ）。
- コード上はこの前提で整合している。ログインできない場合の要因は以下に絞られる。

---

## 初回セットアップ（メーカーでログインできるまで）

**必ずこの順で実行する。**

1. **マイグレーション**
   ```bash
   cd /path/to/Bookshelf
   bin/rails db:migrate
   ```
   - `manufacturers` テーブルと `user_profiles.manufacturer_id` が無いとメーカー用户は作れない。

2. **メーカー・メーカー用户の作成**
   - **パターンA（推奨）**: 既存データを残したい場合  
     `bin/rails users:fix_maker`  
     → メーカー 0 件なら M01〜M04 を自動作成し、メーカー用户（maker-m01〜m04）も自動作成する。
   - **パターンB**: 全データを作り直してよい場合  
     `RESET=1 bin/rails db:seed`  
     → 会社・商品・発注・メーカー・メーカー用户を一括作成。

3. **ログイン**
   - メール: `maker-m01@platform.example.com`（〜m04 まで）
   - パスワード: `SeedPass1`（**S**eed**P**ass**1** の大文字・小文字を厳守、コピペ推奨）

4. **環境の確認**
   - サーバーを起動している **RAILS_ENV**（development / production）と、fix_maker や seed を実行した環境が**同じ**か確認する。
   - 本番でログインするなら、本番 DB に対して `bin/rails users:fix_maker` または seed を実行する必要がある。

---

## 想定される問題と対処

| 要因 | 起きること | 対処 |
|------|------------|------|
| **マイグレーション未実行** | `manufacturers` テーブルや `user_profiles.manufacturer_id` が無く、メーカー用户が作れない。 | `bin/rails db:migrate` を実行する。 |
| **メーカー用户の User がその DB にいない** | 該当メールの User が 1 件も存在しない。 | `bin/rails users:fix_maker` で自動作成する（下記）。 |
| **環境違い** | 開発で seed/fix_maker を流したが、本番や別 DB でログインしている。 | ログインしている環境の DB に対して seed または fix_maker を実行する。 |
| **パスワード不一致** | 入力したパスワードと DB の `encrypted_password` が一致していない。 | `EMAIL=xxx bin/rails users:reset_maker_password` または `users:fix_maker`。 |
| **未確認・ロック・プロファイル不備** | Devise の認証条件を満たしていない。 | `users:diagnose_maker` で要因を確認し、`users:fix_maker` で修正。 |
| **EMAIL=xxx で指定したがその User がいない** | 指定したメールの User が DB に存在しない。 | EMAIL を付けずに `bin/rails users:fix_maker` で自動作成するか、メール typo を確認する。 |

### なぜ「ユーザーが0件」になるか（因果の流れ）

1. **検索時点で 0 件になる理由**  
   `fix_maker` は「メーカー（M01〜M04）のメール（maker-m01@... など）で User を検索」する。まだ誰もメーカー用户を作っていないので、**そもそもそのメールの User が存在せず 0 件**になる。

2. **自動作成されない理由**  
   メーカー用户を**ここで作る**処理は、次の 3 つがすべて満たされるとき**だけ**動く。  
   - 検索結果が 0 件（`users.empty?`）  
   - メーカーが 1 件以上いる（`manufacturers.any?`）  
   - **`user_profiles` に `manufacturer_id` カラムがある**（`UserProfile.column_names.include?("manufacturer_id")`）  
   **`manufacturer_id` が無いと 3 つ目が false のため、自動作成ブロックが実行されない。** その結果、User は 1 件も作られず「ユーザーが見つかりません」のまま終了する。

3. **まとめ**  
   「ユーザーがいない」のは、**メーカー用户を作るために必要な `user_profiles.manufacturer_id` が DB に無い（マイグレーション未実行）ため、自動作成をスキップしている**から。  
   → **対処**: まず `bin/rails db:migrate` を実行し、そのあと `bin/rails users:fix_maker` を実行する。

### その他の要因

- **実行環境と DB の一致**  
  `fix_maker` や seed を実行した RAILS_ENV（development / production）と、ログインしているアプリが参照する DB が違うと、作成した User が「いない」ように見える。同じ DB に対してタスクを実行する。

- **自動作成中の例外**  
  メーカー用户の自動作成中にバリデーションエラーや DB 制約で例外が出ると、タスクがそこで終了する。その場合は「ユーザーが見つかりません」ではなく、ターミナルに表示される例外メッセージを確認する。

---

## ログインできないときのチェックリスト

以下を**上から順に**確認する。

1. **User が存在するか**
   ```bash
   EMAIL=maker-m04@platform.example.com bin/rails users:diagnose_maker
   ```
   - 「ユーザーが存在しません」→ 要因は **User 不在**。`bin/rails users:fix_maker` を実行する。

2. **パスワードが一致するか**
   - 診断で `valid_password?(SeedPass1): ❌ 不一致` の場合 → `EMAIL=xxx bin/rails users:reset_maker_password` または `users:fix_maker`。

3. **認証許可が出ているか**
   - 診断で `active_for_authentication?: false` の場合、その下の理由（confirmed_at・locked_at・user_profile・member_status・manufacturer_id）を確認し、`users:fix_maker` で揃える。

4. **同じ DB を見ているか**
   - ブラウザでアクセスしているアプリ（開発/本番）の `config/database.yml` と、fix_maker を実行したときの DB が一致しているか確認する。

5. **入力ミスがないか**
   - メールは**小文字**でコピペ。パスワードは **SeedPass1**（S・P 大文字、末尾 1）。前後にスペースを入れない。

6. **ブラウザ・キャッシュ**
   - キャッシュ削除またはシークレット窓で試す。サーバー再起動も有効。

---

## 運用確認手順（コマンド一覧）

### マイグレーション

```bash
cd /path/to/Bookshelf
bin/rails db:migrate
```

### メーカー・メーカー用户の作成・修正（fix_maker）

```bash
bin/rails users:fix_maker
```

- 特定メールだけ: `EMAIL=maker-m04@platform.example.com bin/rails users:fix_maker`
- 実行後、表示の「パスワード一致=true, 認証許可=true」を確認する。

### ログインできない要因の特定（diagnose_maker）

```bash
EMAIL=maker-m04@platform.example.com bin/rails users:diagnose_maker
```

- パスワードを変えて試している場合: `PASSWORD=入力しているパスワード` を付ける。

### パスワードだけリセット

```bash
EMAIL=maker-m04@platform.example.com bin/rails users:reset_maker_password
```

### Seed で一から作り直す

```bash
RESET=1 bin/rails db:seed
```

- seed 実行時に「※ メーカーアカウントはスキップ（…）」と出た場合は、記載のとおりマイグレーションを実行してから再度 seed する。

---

## ログイン情報（seed / fix_maker 後）

| メール | パスワード |
|--------|------------|
| maker-m01@platform.example.com 〜 maker-m04@platform.example.com | SeedPass1 |

- メールは**小文字**で入力（コピペ推奨）。
- パスワードは **S**eed**P**ass**1**（先頭 S・P 大文字、末尾 1）。

---

## fix_maker で「ユーザーが見つかりません」と出る場合

- **manufacturers テーブルが無い** → `bin/rails db:migrate`
- **user_profiles.manufacturer_id が無い** → `bin/rails db:migrate`
- 上記を実行したうえで再度 `bin/rails users:fix_maker` を実行する。メーカー 0 件なら M01〜M04 を自動作成し、その後にメーカー用户を自動作成する。

---

## 参考: Rake タスク一覧

| タスク | 説明 |
|--------|------|
| `users:fix_maker` | メーカー用户の作成・パスワード/ロック解除。EMAIL 未指定なら全メーカー用户。 |
| `users:diagnose_maker` | 指定メールの用户について、ログインできない要因を表示。 |
| `users:reset_maker_password` | 指定メールの用户のパスワードを SeedPass1 にリセットし、検証結果を表示。 |

---

## 参考: ログイン失敗の要因（Devise の流れ）

ログイン時、次の順でチェックされる。どれかで失敗すると 401 になる。

| # | チェック | 失敗時の要因 |
|---|----------|----------------|
| 1 | メールで User を検索 | User が存在しない（別 DB・未作成） |
| 2 | `valid_password?(password)` | パスワード不一致 |
| 3 | `active_for_authentication?` | 下記のいずれか |
| 3a | （内部）`super`（confirmable 等） | `confirmed_at` が nil、または `locked_at` が入っている |
| 3b | `user_profile&.active?` | user_profile が nil、または `member_status` が active ではない |

`users:diagnose_maker` は上記 1〜3 をまとめて表示する。

---

## 参考: コード上でメーカーが絡む主な箇所（開発者向け）

| 箇所 | 内容 |
|------|------|
| `User#current_company` | メーカー用户では `nil`（`user_profile&.company` のみ）。 |
| `User#create_user_profile_from_domain` | メールが `maker-*@platform.example.com` のときはスキップ（seed でプロファイルを明示作成）。 |
| `Manufacturer` モデル | `company` / `company_id` は無い（プラットフォーム共通）。 |
| `ManufacturerPolicy::Scope` | メーカー用户は自メーカー 1 件のみ。内部管理者・利用会社は全件。 |
| `ShippingRequestsController` | メーカー用户は index で自メーカー詳細へリダイレクト。show/pdf は当該メーカーが紐づく発注を**全社**から取得。 |
| `ApplicationController#restrict_manufacturer_user_to_shipping_requests` | メーカー用户は発送依頼以外・管理画面へ行くと発送依頼にリダイレクト。 |
| `UserProfile` | メーカー用户は `company_id: nil`, `manufacturer_id` のみ。`company_optional?` で presence をスキップ。 |
| `db/seeds.rb` | メーカー用户作成後に `Devise::Encryptor.digest` で `encrypted_password` を直接設定してログインを保証。 |
| `config/routes.rb` | `shipping_requests/:manufacturer_id/pdf` を `shipping_requests/:manufacturer_id` より**先**に定義（PDF の誤マッチ防止）。 |
