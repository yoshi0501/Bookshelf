# 通信暗号化・データセンター・アクセス制御に関する現状の回答

本ドキュメントは、現行アプリケーション（Bookshelf）およびリポジトリ上で確認できる範囲に基づく回答です。インフラ（データセンター所在地・VPN・リバースプロキシの SSL 終端など）は**デプロイ先により異なる**ため、運用・契約で別途確認・明示する必要があります。

---

## 1. データセンターの所在地（日本国内優先・海外の場合の法令確認）

**現状のアプリでの扱い**

- アプリケーションおよびリポジトリには、**データセンターの所在地やリージョンを指定・表示する設定はありません**。
- DB（PostgreSQL）の接続先は `config/database.yml` で `host` 等を環境変数で指定する形であり、「日本国内」かどうかはデプロイ環境に依存します。

**回答として記載する場合の例**

- **方針**: クラウドサービス事業者のデータセンターは**日本国内を優先的に選定**する。
- **海外設置の場合**: データセンターが海外に設置されている場合は、設置国の法令が当社業務に及ぼす影響について、**事業者に事前に詳細確認**したうえで利用の可否を判断する。
- **運用上の補足**: 上記は契約・選定時の方針として文書化し、実際のホスティング先（AWS 東京リージョン、GCP asia-northeast1、オンプレ等）がこれに合致していることを運用で確認する。

---

## 2. 通信の暗号化（端末～クラウドサービス間）

**現状のアプリでの扱い**

- **Rails 側**  
  - `config/environments/production.rb` に `config.force_ssl = true` の記述はあるが、**コメントアウト**されています（`# config.force_ssl = true`）。  
  - 本番では、**リバースプロキシ（Nginx / ALB / CloudFront 等）で HTTPS 終端し、SSL/TLS で通信させる**運用が一般的です。その場合、端末からクラウドサービスまでの区間は SSL/TLS で暗号化されている。
- **フレームワークの SSL オプション**  
  - `config/initializers/new_framework_defaults.rb` で `Rails.application.config.ssl_options = { hsts: { subdomains: true } }` が設定されています。`force_ssl` を有効にすると、HSTS（HTTP Strict Transport Security）も有効化され、ブラウザに HTTPS 利用を強制できます。

**回答として記載する場合の例**

- **実施内容**: クラウドサービスを利用する情報機器からクラウドサービスに至るまでの通信は、**SSL/TLS による暗号化通信**を用いる。
- **具体的な措置**  
  - 本番環境では HTTPS を利用し、必要に応じてアプリケーション側で `config.force_ssl = true` を有効化する（またはリバースプロキシで HTTP を HTTPS にリダイレクトし、SSL 終端する）。  
  - より厳格にする場合は、VPN（仮想プライベートネットワーク）経由でのみアクセス可能とする構成を検討する。
- **確認方法**: 本番 URL が `https://` で提供されていること、および必要に応じて HSTS ヘッダーが返却されていることを確認する。

**推奨（アプリ側）**: 本番で SSL を強制するため、`config/environments/production.rb` の `config.force_ssl = true` のコメントを外して有効化することを推奨します（リバースプロキシで既に HTTPS のみ受け付ける場合は、二重の強制となり安全性が高まります）。

---

## 3. 不正アクセス防止のためのアクセス制御（パスワード認証・二要素認証）

**現状のアプリでの扱い**

- **パスワード認証**  
  - **Devise** により、メールアドレス＋パスワードによる認証を実施しています。  
  - **パスワード長**: 12 文字以上 128 文字以下（`config.password_length = 12..128`）。  
  - **パスワードポリシー（devise-security）**  
    - 有効期限: 90 日（`config.expire_password_after = 90.days`）。  
    - 変更時、直近 5 件のパスワードの再利用を禁止（`config.deny_old_passwords = 5`）。  
  - **ロック機能（Lockable）**  
    - ログイン失敗 5 回でアカウントロック、1 時間後に解除（またはリセットメールで解除）。  
  - 全画面で `before_action :authenticate_user!` により、未ログイン時はログイン画面へリダイレクトしています。
- **二要素認証（2FA / MFA）**  
  - **未導入**です。Gemfile に `devise-two-factor` の記述はありますがコメントアウト（将来実装用）されており、現状はパスワード認証のみです。

**回答として記載する場合の例**

- **実施内容**: クラウドサービスはインターネット経由で利用するため、不正アクセス防止の観点から以下のアクセス制御を行っている。
  - **パスワード認証**: メールアドレスおよびパスワードによる認証を必須とし、パスワードは 12 文字以上、90 日ごとの変更を促し、直近 5 回分の再利用を禁止している。  
  - **ロックアウト**: 連続してログインに失敗した場合、一定時間アカウントをロックする。  
  - **二要素認証**: 現時点では**パスワード認証のみ**。二要素認証（2FA/MFA）の導入は、セキュリティ強化の観点から**検討・導入予定**（または「要件に応じて導入する」）と記載する。
- **補足**: 契約形態や利用端末の種類に拠らず、上記の認証を経たうえでないと本システムの利用はできない設計である。

---

## まとめ

| 項目 | 現状 | 回答時の記載例 |
|------|------|----------------|
| データセンター所在地 | アプリで指定なし。デプロイ先に依存。 | 日本国内を優先選定。海外の場合は設置国法令の影響を事業者に事前確認。 |
| 通信暗号化 | 本番で `force_ssl` はコメントアウト。プロキシで HTTPS 運用が一般的。 | SSL/TLS による暗号化通信を利用。必要に応じて VPN 検討。本番で `force_ssl` 有効化を推奨。 |
| パスワード認証 | Devise で実装済み（12 文字以上、90 日期限、再利用禁止、ロック）。 | パスワード認証を実施。長さ・期限・ロックで不正アクセスを防止。 |
| 二要素認証 | 未導入（Gemfile でコメントアウト）。 | 現状はパスワード認証のみ。2FA は検討・導入予定として記載可能。 |

上記を踏まえ、**データセンター所在地**は契約・運用で明示し、**通信暗号化**は本番で HTTPS（および必要なら `force_ssl`）を確実に有効化したうえで「SSL/TLS を用いている」と回答し、**二要素認証**は「現状はパスワード認証、2FA は検討中」などと区別して記載することを推奨します。
