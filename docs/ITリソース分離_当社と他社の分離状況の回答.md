# 当社が利用しているITリソースと他社が利用しているITリソースの分離状況 — 確認と回答

「当社が利用しているITリソースと他社が利用しているITリソースがどの程度分離されているか確認する。利用者によるアクセス権限設定誤りによって他社にデータが漏洩しない程度に分離されていることが望ましい。」との要件に対する、本システム（Bookshelf）の回答です。

---

## 1. 分離の方式（結論）

本システムでは、**同一のサーバー・同一のデータベース上で、論理的にテナント（会社）ごとにデータを分離**しています。  
仮想マシンやコンテナによる「仮想的にITリソースが分離されている」構成（テナントごとに別VM・別DB等）はとっておらず、**同一アプリケーション・同一DB内での論理分離**です。

| 分離の種類 | 本システムの状況 |
|------------|------------------|
| 物理的・仮想的なリソース分離（テナントごとに別サーバー・別DB等） | **行っていない**。全テナントが同一アプリケーション・同一データベースを共有する構成です。 |
| 同一サーバー上での論理的な分離 | **実施している**。データベース内の全テナント向けデータに「会社ID（company_id）」を付与し、アプリケーション層で必ずこの会社IDによりスコープを限定してアクセスしています。 |

---

## 2. 論理分離の具体的な実装

### 2.1 データ層での分離

- 発注（Order）、顧客拠点（Customer）、商品（Item）、発注承認（OrderApprovalRequest）、メンバー承認（ApprovalRequest）、ユーザープロファイル（UserProfile）をはじめ、テナントに紐づくデータにはすべて **company_id** を持たせています。
- 各レコードは「どの会社のデータか」が company_id で一意に決まり、**他社のデータと同一テーブル内で混在しないよう会社IDで区別**しています。
- 一意制約も会社スコープで設定しています（例：発注番号は会社ごとに一意、商品コードは会社ごとに一意）。

### 2.2 アプリケーション層でのアクセス制御（他社データ漏洩の防止）

- **ログインユーザーに紐づく会社**  
  各ユーザーは、承認フロー等により**いずれか1社**（またはメーカー）に紐づきます。この「ユーザーに紐づく会社」を、一覧・詳細・更新の可否判定に使用しています。
- **一覧（index）**  
  一覧取得時は、**ポリシー（Pundit）の Scope** により、**そのユーザーが属する会社のデータのみ**に絞り込みます。会社管理者・一般ユーザーは他社のデータが一覧に一切出ない実装です。  
  （内部管理者のみ、運用上全社のデータを参照できる設計です。）
- **詳細・更新・削除（show / update / destroy 等）**  
  各アクションで **same_company?** 等により「対象レコードの company_id が、ログインユーザーの会社と一致するか」を必ずチェックしています。一致しない場合は認可エラーとし、他社データの参照・変更はできません。
- **自動スコープの徹底**  
  テナント用モデルでは「デフォルトスコープで company を限定する」方式は採用せず、**一覧は必ず policy_scope 経由**とし、**個別レコード操作は必ず authorize で same_company? を判定**する形で、誤って他社データにアクセスしないようにしています。

このため、**利用者によるアクセス権限の設定誤り**（例：自社内で「管理者」や「一般」を誤って付与した場合）があったとしても、**他社のデータが一覧に表示されたり、他社のデータを参照・変更したりすることはできません**。  
他社データへのアクセス可否は「そのユーザーがどの会社に紐づいているか」で決まり、ロール（権限）の設定だけでは他社スコープにはならない設計です。

---

## 3. 利用者によるアクセス権限設定誤りと他社データ漏洩

- **他社データの参照・更新**  
  上記のとおり、**会社単位の論理分離**と**ポリシーによる会社スコープの強制**により、通常の利用者（会社管理者・一般ユーザー）が他社のデータにアクセスすることはできません。  
  アクセス権限（ロール）の設定を誤っても、**他社にデータが漏洩しない程度に分離されている**と判断しています。
- **自社内の権限誤り**  
  誤って自社内の別ユーザーに広い権限を付与した場合は、その自社内のデータにはアクセス可能になりますが、**他社のデータには引き続きアクセスできません**。

---

## 4. まとめ（回答として記載する場合の例）

| 確認事項 | 本システムの対応 |
|----------|------------------|
| 当社と他社のITリソースの分離の程度 | **同一サーバー・同一データベース上で、論理的に分離**しています。テナント（会社）ごとに company_id を付与し、アプリケーション層で必ずこの company_id により参照・更新範囲を限定しています。 |
| 仮想的又は論理的な分離の有無 | **論理的な分離を実施**しています。仮想マシン・コンテナによるテナント単位のリソース分離は行っていません。 |
| 利用者によるアクセス権限設定誤りによる他社へのデータ漏洩 | **他社データへのアクセスは、ユーザーが属する会社（company_id）で制御**しており、ロールの設定誤りだけでは他社データは参照・取得できません。このため、**利用者によるアクセス権限設定誤りによって他社にデータが漏洩しない程度に分離されている**と判断しています。 |

上記を踏まえ、本システムでは「**同一サーバー上で論理的に分離されている**」構成であり、**利用者によるアクセス権限設定誤りによって他社にデータが漏洩しない程度に分離されている**旨を回答として記載できます。
